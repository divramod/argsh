#!/usr/bin/env bash
set -eu -o pipefail

[ -f "${1:-}" ] || {
  echo "Help is comming. ðŸ¤•"
  exit 1
}

ARGSH_READLINK='true'
if command -v 'greadlink' >/dev/null; then
  ARGSH_READLINK='greadlink'
elif command -v 'readlink' >/dev/null; then
  ARGSH_READLINK='readlink'
fi

_argsh_resolve_absolute_root_dir() {
  local -r cwd="${PWD}"
  local -r result="${2}"
  local -r original_shell_options="${-}"
  local path="${1}"
  local target_dir
  local target_name

  # Resolve the parent directory, e.g. /bin => /usr/bin on CentOS (https://github.com/bats-core/bats-core/issues/113).
  set -P

  while true; do
    target_dir="${path%/*}"
    target_name="${path##*/}"

    if [[ "${target_dir}" != "${path}" ]]; then
      cd "${target_dir}"
    fi

    if [[ -L "${target_name}" ]]; then
      path="$("${ARGSH_READLINK}" "${target_name}")"
    else
      printf -v "${result}" -- '%s' "${PWD%/*}"
      set +P "-${original_shell_options}"
      cd "${cwd}"
      return
    fi
  done
}

export ARGSH_ROOT
_argsh_resolve_absolute_root_dir "${0}" 'ARGSH_ROOT'
export ARGSH_SHELL
ARGSH_SHELL="bash"
export ARGSH_SOURCE
ARGSH_SOURCE="${1}"
export ARGSH_ROOT_SOURCE
ARGSH_ROOT_SOURCE="$(realpath "$(dirname "${ARGSH_SOURCE}")")"

export ARGSH_LIBEXEC="${ARGSH_ROOT}/libexec/argsh"
source "${ARGSH_LIBEXEC}/arg.sh"
source "${ARGSH_LIBEXEC}/validator.sh"

for setting in $(_argsh_settings "${ARGSH_SOURCE}"); do case "${setting}" in
  shell=*)
    ARGSH_SHELL="${setting:6}"
    echo "${ARGSH_SHELL}" | grep -qE '^(bash|sh|zsh)$' || {
      _error "argsh does not support wanted shell: ${ARGSH_SHELL}"
    }
  ;;
  source=*)
    path="$(realpath "${ARGSH_ROOT_SOURCE}/${setting:7}")"
    [ -f "${path}" ] || {
      _error "source path does not exist: ${path}"
    }
    source "${path}"
  ;;
esac; done

# remove first argument (script path)
_argsh "${@:2}"

exec "${ARGSH_SHELL}" "${@}"